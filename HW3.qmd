---
title: "SURV-740 Homework 3: Introduction to Causal Inference"
author: "Namit Shrivastava"
format: 
  pdf:
    prefer-html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(lpSolve)
library(dplyr)
library(knitr)
```

## Problem 1 Verify the bounds for the mean of potential outcome under control in **never takers** and **compliers** (NN and NY), that is $$\theta_{00}^{(0)} \quad \text{and} \quad \theta_{10}^{(0)}$$ as shown in the SSC Example. *(Note: the results shown in the lecture slides might be incorrect.)*

So, to solve this problem, I need to derive the sharp bounds for the potential outcome means under control for different principal strata using the correct SSC (Small Schools of Choice) example data. Let me start by setting up the problem with the given data.

```{r problem1-setup}
# SSC Example Data from lecture
# Z: SSC offer (Z=1 for offer, Z=0 for no offer)  
# A: Academic status (A=Y for "on track", A=N for "off track")
# Y: High school graduation outcome

# Observed probabilities of academic status A given treatment Z
pi_0N <- 0.49  # P(A=N | Z=0) - off track when no SSC offer
pi_0Y <- 0.51  # P(A=Y | Z=0) - on track when no SSC offer  
pi_1N <- 0.35  # P(A=N | Z=1) - off track when SSC offered
pi_1Y <- 0.65  # P(A=Y | Z=1) - on track when SSC offered

# Observed graduation rates Y given treatment Z and academic status A
mu_0N <- 0.34  # E[Y | Z=0, A=N] - graduation rate: no offer, off track
mu_0Y <- 0.86  # E[Y | Z=0, A=Y] - graduation rate: no offer, on track
mu_1N <- 0.38  # E[Y | Z=1, A=N] - graduation rate: SSC offer, off track  
mu_1Y <- 0.89  # E[Y | Z=1, A=Y] - graduation rate: SSC offer, on track

cat("SSC Example Data:\n")
cat("Academic Status Probabilities:\n")
cat(sprintf("P(A=N|Z=0) = %.2f, P(A=Y|Z=0) = %.2f\n", pi_0N, pi_0Y))
cat(sprintf("P(A=N|Z=1) = %.2f, P(A=Y|Z=1) = %.2f\n", pi_1N, pi_1Y))
cat("\nGraduation Rates:\n")
cat(sprintf("E[Y|Z=0,A=N] = %.2f, E[Y|Z=0,A=Y] = %.2f\n", mu_0N, mu_0Y))
cat(sprintf("E[Y|Z=1,A=N] = %.2f, E[Y|Z=1,A=Y] = %.2f\n", mu_1N, mu_1Y))
```

Now I'll derive the sharp bounds using the algebraic approach based on the mixture equation. Under the monotonicity assumption (no defiers), I have three principal strata.

```{r problem1-strata-proportions}
# Under monotonicity assumption: no defiers (YN stratum doesn't exist)
# Principal strata proportions can be calculated as:

# Never-takers (NN): students off track regardless of SSC offer
pi_NN <- pi_1N  # P(A=N | Z=1) = 0.35

# Always-takers (YY): students on track regardless of SSC offer  
pi_YY <- pi_0Y  # P(A=Y | Z=0) = 0.51

# Compliers (NY): students who are off track without SSC but on track with SSC
pi_NY <- pi_0N - pi_1N  # P(A=N | Z=0) - P(A=N | Z=1) = 0.49 - 0.35 = 0.14

cat("Principal Strata Proportions:\n")
cat(sprintf("Never-takers (NN): π_NN = %.2f\n", pi_NN))
cat(sprintf("Always-takers (YY): π_YY = %.2f\n", pi_YY))  
cat(sprintf("Compliers (NY): π_NY = %.2f\n", pi_NY))
cat(sprintf("Total: %.2f\n\n", pi_NN + pi_YY + pi_NY))

# Verification: these should sum to 1
stopifnot(abs((pi_NN + pi_YY + pi_NY) - 1) < 1e-10)
```

```{r problem1-analytical-bounds}
# Now derive the bounds using the correct mixture equation approach
cat("Computing bounds using mixture equation:\n\n")

# Key insight: The mixture equation relates to the off-track group in control (Z=0, A=N)
# This group consists of Never-takers (NN) and Compliers (NY)

# The off-track group in control has graduation rate μ₀ₙ = 0.34
# So, this group consists of:
# - Never-takers (NN): off-track in both conditions, proportion π_NN = 0.35
# - Compliers (NY): off-track in control, on-track in treatment, proportion π_NY = 0.14

# Proportions within the off-track control group:
prop_NN_in_control_offtrack <- pi_NN / pi_0N  # = 0.35/0.49 = 5/7
prop_NY_in_control_offtrack <- pi_NY / pi_0N  # = 0.14/0.49 = 2/7

cat("Key mixture equation for off-track group in control:\n")
cat("μ₀ₙ = P(NN | Z=0, A=N) × θ₀₀⁽⁰⁾ + P(NY | Z=0, A=N) × θ₀₁⁽⁰⁾\n")
cat(sprintf("%.2f = (%.0f/%.0f) × θ₀₀⁽⁰⁾ + (%.0f/%.0f) × θ₀₁⁽⁰⁾\n", 
            mu_0N, 5, 7, 2, 7))
cat(sprintf("%.2f = %.3f × θ₀₀⁽⁰⁾ + %.3f × θ₀₁⁽⁰⁾\n\n", 
            mu_0N, prop_NN_in_control_offtrack, prop_NY_in_control_offtrack))

# For bounds on θ₀₀⁽⁰⁾, we rearrange: θ₀₀⁽⁰⁾ = (μ₀ₙ - (2/7) × θ₀₁⁽⁰⁾) / (5/7)
# Since θ₀₁⁽⁰⁾ is bounded between 0 and 1:

cat("Bounds for θ₀₀⁽⁰⁾ (Never-takers graduation rate under control):\n")
cat("Rearranging: θ₀₀⁽⁰⁾ = (μ₀ₙ - (2/7) × θ₀₁⁽⁰⁾) / (5/7)\n\n")

# Minimum θ₀₀⁽⁰⁾: set θ₀₁⁽⁰⁾ = 1 (compliers have maximum graduation rate under control)
theta_00_min <- (mu_0N - (2/7) * 1) / (5/7)
cat(sprintf("Minimum θ₀₀⁽⁰⁾ (when θ₀₁⁽⁰⁾ = 1): %.3f\n", theta_00_min))

# Maximum θ₀₀⁽⁰⁾: set θ₀₁⁽⁰⁾ = 0 (compliers have minimum graduation rate under control)
theta_00_max <- (mu_0N - (2/7) * 0) / (5/7)
cat(sprintf("Maximum θ₀₀⁽⁰⁾ (when θ₀₁⁽⁰⁾ = 0): %.3f\n", theta_00_max))

# Bounds are automatically valid since they come from the constraint equation
cat(sprintf("\nSharp bounds for θ₀₀⁽⁰⁾: [%.3f, %.3f]\n\n", theta_00_min, theta_00_max))

cat("Bounds for θ₁₀⁽⁰⁾ (YN stratum - defiers):\n")
cat("Under monotonicity assumption, the YN stratum (A₀=1, A₁=0) doesn't exist.\n")
cat("Therefore, θ₁₀⁽⁰⁾ is undefined, or equivalently, its bounds are [0, 1] vacuously.\n\n")

cat(sprintf("Sharp bounds for θ₁₀⁽⁰⁾: [0, 1] (vacuous - stratum doesn't exist)\n"))

# Storing bounds for the final answer
bounds_NN <- c(theta_00_min, theta_00_max)
bounds_YN <- c(0, 1)  # Vacuous bounds for non-existent stratum
```

Based on the mixture equation analysis under the monotonicity assumption, I found the sharp bounds for the potential outcome means under control. The key insight is that the off-track group in control (Z=0, A=N) consists of never-takers and compliers in proportions 5/7 and 2/7 respectively. This leads to the mixture equation: $0.34 = \frac{5}{7} \times \theta_{00}^{(0)} + \frac{2}{7} \times \theta_{01}^{(0)}$.

For never-takers (NN stratum where students are off track regardless of SSC offer), the bounds for $\theta_{00}^{(0)} = E[Y^0|\text{Never-takers}]$ are [`r sprintf("%.3f", bounds_NN[1])`, `r sprintf("%.3f", bounds_NN[2])`]. These bounds are derived by allowing compliers' graduation rate under control ($\theta_{01}^{(0)}$) to vary between 0 and 1. When $\theta_{01}^{(0)} = 1$, we get the lower bound of `r sprintf("%.3f", bounds_NN[1])`, and when $\theta_{01}^{(0)} = 0$, we get the upper bound of `r sprintf("%.3f", bounds_NN[2])`.

For the YN stratum (defiers), $\theta_{10}^{(0)}$ has vacuous bounds [`r sprintf("%.0f", bounds_YN[1])`, `r sprintf("%.0f", bounds_YN[2])`] since this stratum doesn't exist under the monotonicity assumption. 

Hence, these bounds represent the range of possible values for the mean potential outcomes under control that are consistent with the observed SSC data and the monotonicity assumption.

## Problem 2 We have the following variables:

- $Z$: Receipt of letter from physician to encourage flu shot  
  $$Z = \begin{cases}
  1 & \text{received letter} \\
  0 & \text{did not receive letter}
  \end{cases}$$

- $A$: Patient decides to receive the flu shot  
  $$A = \begin{cases}
  1 & \text{took flu shot} \\
  0 & \text{did not take flu shot}
  \end{cases}$$

- $Y$: Hospitalization  
  $$Y = \begin{cases}
  1 & \text{hospitalized} \\
  0 & \text{not hospitalized}
  \end{cases}$$

We observed that the probability of $A = a$ given $Z = z$ is

$$p_{za} = (p_{00}, p_{01}, p_{10}, p_{11}) = (0.30, 0.70, 0.10, 0.90)$$

and the probability of hospitalization $(Y = 1)$ for patients with $A = a$ and $Z = z$ is

$$\theta_{za} = (\theta_{00}, \theta_{01}, \theta_{10}, \theta_{11}) = (0.1, 0.08, 0.2, 0.15)$$

**Research question:**  
What are the impacts of the physician's encouragement letter on hospitalization for those who are **induced by the letter to take the flu shot (compliers)?**

### 1. Define the principal strata

```{r problem2-strata}
# Here, the Principal strata are defined by potential treatment values under both instrument values
cat("Principal Strata Definitions:\n")
cat("1. Never-takers (NN): A⁰ = 0, A¹ = 0\n")
cat("   - Would not take flu shot regardless of letter\n\n")
cat("2. Compliers (NY): A⁰ = 0, A¹ = 1\n") 
cat("   - Would take flu shot only if they receive the letter\n\n")
cat("3. Defiers (AN): A⁰ = 1, A¹ = 0\n")
cat("   - Would take flu shot only if they don't receive the letter\n\n")
cat("4. Always-takers (AY): A⁰ = 1, A¹ = 1\n")
cat("   - Would take flu shot regardless of letter\n")
```

The principal strata are defined based on individuals' potential treatment behaviors under both values of the instrument. Never-takers would never take the flu shot regardless of receiving the letter, compliers would only take the shot if they receive the encouraging letter, defiers would paradoxically only take the shot if they don't receive the letter, and always-takers would take the shot regardless of the letter.

### 2. Principal strata memberships for those who received letter and took flu shot

```{r problem2-membership}
cat("For individuals with (Z=1, A=1):\n")
cat("Possible principal strata:\n")
cat("- Compliers (NY): A⁰=0, A¹=1 → Under Z=1, they take shot (A=1) ✓\n")
cat("- Always-takers (AY): A⁰=1, A¹=1 → Under Z=1, they take shot (A=1) ✓\n\n")
cat("Not possible:\n")
cat("- Never-takers (NN): A⁰=0, A¹=0 → Under Z=1, they wouldn't take shot ✗\n")
cat("- Defiers (AN): A⁰=1, A¹=0 → Under Z=1, they wouldn't take shot ✗\n")
```

So, for individuals who received the physician's encouragement letter and took the flu shot (Z=1, A=1), they could belong to either the compliers stratum (who take the shot only when encouraged) or the always-takers stratum (who would take the shot regardless). They cannot be never-takers or defiers because both of these groups would not take the shot when Z=1.

### 3. Possible observed values for principal stratum AT (Always-takers)

```{r problem2-at-observations}
cat("For Always-takers (AY stratum: A⁰=1, A¹=1):\n")
cat("Possible observed (Z,A) combinations:\n")
cat("- When Z=0: A = A⁰ = 1 → (Z=0, A=1)\n")
cat("- When Z=1: A = A¹ = 1 → (Z=1, A=1)\n\n")
cat("Always-takers always receive treatment A=1 regardless of instrument value.\n")
```

For patients in the always-takers stratum (AT), the possible observed values of (Z,A) are (0,1) and (1,1). This is because always-takers have A⁰=1 and A¹=1, meaning they always take the treatment regardless of whether they receive the encouraging letter or not.

### 4. Assumptions of monotonicity and exclusion restrictions

```{r problem2-assumptions}
cat("MONOTONICITY ASSUMPTION:\n")
cat("A¹ ≥ A⁰ for all individuals\n")
cat("- No one is a defier (A⁰=1, A¹=0)\n")
cat("- Receiving the letter can only increase (or maintain) flu shot uptake\n\n")

cat("EXCLUSION RESTRICTION:\n") 
cat("Y^a is independent of Z for all individuals and all a\n")
cat("- The letter affects hospitalization ONLY through its effect on flu shot uptake\n")
cat("- No direct effect of letter on hospitalization\n\n")

cat("PLAUSIBILITY ASSESSMENT:\n")
cat("Monotonicity: PLAUSIBLE\n")
cat("- Reasonable that encouragement letter only increases flu shot uptake\n")
cat("- Hard to imagine letter discouraging someone who would otherwise get shot\n\n")

cat("Exclusion Restriction: QUESTIONABLE\n")
cat("- Letter might have direct psychological effects on health behavior\n") 
cat("- Could affect healthcare seeking behavior beyond just flu shots\n")
cat("- Physician contact itself might influence hospitalization patterns\n")
```

I find the monotonicity assumption quite plausible in this context because it's reasonable to expect that a physician's encouraging letter would only increase (or have no effect on) flu shot uptake, rather than discourage it. However, the exclusion restriction is more questionable because the physician's letter might have direct effects on hospitalization beyond just encouraging flu shots, it could influence other health behaviors, increase healthcare engagement, or have psychological effects on patient wellbeing.

### 5. Estimation using principal stratification and instrumental variables

```{r problem2-estimation}
# Given data
p_00 <- 0.30  # P(A=0|Z=0)
p_01 <- 0.70  # P(A=1|Z=0)  
p_10 <- 0.10  # P(A=0|Z=1)
p_11 <- 0.90  # P(A=1|Z=1)

theta_00 <- 0.10  # P(Y=1|Z=0,A=0)
theta_01 <- 0.08  # P(Y=1|Z=0,A=1)
theta_10 <- 0.20  # P(Y=1|Z=1,A=0)
theta_11 <- 0.15  # P(Y=1|Z=1,A=1)

cat("DATA SUMMARY:\n")
cat(sprintf("P(A=1|Z=0) = %.2f, P(A=1|Z=1) = %.2f\n", p_01, p_11))
cat(sprintf("P(Y=1|Z=0,A=0) = %.2f, P(Y=1|Z=0,A=1) = %.2f\n", theta_00, theta_01))
cat(sprintf("P(Y=1|Z=1,A=0) = %.2f, P(Y=1|Z=1,A=1) = %.2f\n\n", theta_10, theta_11))

cat("STEP 1: COMPUTE PRINCIPAL STRATA PROPORTIONS\n")
cat("Under monotonicity assumption (no defiers), we have three strata: NT, C, AT\n\n")

# Principal strata proportions under monotonicity
pi_AT <- p_01  # Always-takers: P(A=1|Z=0) = 0.70
pi_NT <- p_10  # Never-takers: P(A=0|Z=1) = 0.10  
pi_C <- p_11 - p_01  # Compliers: P(A=1|Z=1) - P(A=1|Z=0) = 0.90 - 0.70 = 0.20

cat(sprintf("π_NT (Never-takers) = %.2f\n", pi_NT))
cat(sprintf("π_C (Compliers) = %.2f\n", pi_C))
cat(sprintf("π_AT (Always-takers) = %.2f\n", pi_AT))
cat(sprintf("Total = %.2f (check)\n\n", pi_NT + pi_C + pi_AT))

cat("METHOD 1: PRINCIPAL STRATIFICATION\n")
cat("Apply exclusion restriction: Z affects Y only through A\n")
cat("For AT and NT: θ^(1) = θ^(0) since their A doesn't change\n\n")

# Step 1: Identifying rates for AT and NT using exclusion restriction
# (Z=1,A=0) consists only of Never-takers
theta_NT_0 <- theta_10  # = theta_NT_1 by exclusion restriction
theta_NT_1 <- theta_NT_0

# (Z=0,A=1) consists only of Always-takers  
theta_AT_0 <- theta_01  # = theta_AT_1 by exclusion restriction
theta_AT_1 <- theta_AT_0

cat("Identified rates using exclusion restriction:\n")
cat(sprintf("θ_NT^(0) = θ_NT^(1) = %.3f (from P(Y=1|Z=1,A=0))\n", theta_NT_0))
cat(sprintf("θ_AT^(0) = θ_AT^(1) = %.3f (from P(Y=1|Z=0,A=1))\n\n", theta_AT_0))

# Step 2: Solving mixture equations for Compliers
# (Z=0,A=0) is mixture of NT and C
weight_NT_in_z0a0 <- pi_NT / p_00  # = 0.10/0.30 = 1/3
weight_C_in_z0a0 <- pi_C / p_00    # = 0.20/0.30 = 2/3

cat("Mixture equation for (Z=0,A=0):\n")
cat(sprintf("θ_00 = π_NT/p_00 × θ_NT^(0) + π_C/p_00 × θ_C^(0)\n"))
cat(sprintf("%.2f = (%.2f/%.2f) × %.3f + (%.2f/%.2f) × θ_C^(0)\n", 
            theta_00, pi_NT, p_00, theta_NT_0, pi_C, p_00))
cat(sprintf("%.2f = %.3f × %.3f + %.3f × θ_C^(0)\n", 
            theta_00, weight_NT_in_z0a0, theta_NT_0, weight_C_in_z0a0))

# Solving for theta_C_0
theta_C_0 <- (theta_00 - weight_NT_in_z0a0 * theta_NT_0) / weight_C_in_z0a0

cat(sprintf("θ_C^(0) = (%.2f - %.3f × %.3f) / %.3f = %.3f\n\n", 
            theta_00, weight_NT_in_z0a0, theta_NT_0, weight_C_in_z0a0, theta_C_0))

# (Z=1,A=1) is mixture of AT and C
weight_AT_in_z1a1 <- pi_AT / p_11  # = 0.70/0.90 = 7/9
weight_C_in_z1a1 <- pi_C / p_11    # = 0.20/0.90 = 2/9

cat("Mixture equation for (Z=1,A=1):\n")
cat(sprintf("θ_11 = π_AT/p_11 × θ_AT^(1) + π_C/p_11 × θ_C^(1)\n"))
cat(sprintf("%.2f = (%.2f/%.2f) × %.3f + (%.2f/%.2f) × θ_C^(1)\n", 
            theta_11, pi_AT, p_11, theta_AT_1, pi_C, p_11))
cat(sprintf("%.2f = %.3f × %.3f + %.3f × θ_C^(1)\n", 
            theta_11, weight_AT_in_z1a1, theta_AT_1, weight_C_in_z1a1))

# Solving for theta_C_1
theta_C_1 <- (theta_11 - weight_AT_in_z1a1 * theta_AT_1) / weight_C_in_z1a1

cat(sprintf("θ_C^(1) = (%.2f - %.3f × %.3f) / %.3f = %.3f\n\n", 
            theta_11, weight_AT_in_z1a1, theta_AT_1, weight_C_in_z1a1, theta_C_1))

# Computing CACE
cace_ps <- theta_C_1 - theta_C_0

cat("Principal Stratification Results:\n")
cat(sprintf("θ_C^(0) (Compliers under control) = %.3f\n", theta_C_0))
cat(sprintf("θ_C^(1) (Compliers under treatment) = %.3f\n", theta_C_1))
cat(sprintf("CACE = θ_C^(1) - θ_C^(0) = %.3f - %.3f = %.3f\n\n", 
            theta_C_1, theta_C_0, cace_ps))

cat("METHOD 2: INSTRUMENTAL VARIABLES\n")
cat("CACE = [E[Y|Z=1] - E[Y|Z=0]] / [E[A|Z=1] - E[A|Z=0]]\n\n")

# Computing marginal expectations
ey_z1 <- p_10 * theta_10 + p_11 * theta_11
ey_z0 <- p_00 * theta_00 + p_01 * theta_01
ea_z1 <- p_11  # P(A=1|Z=1)
ea_z0 <- p_01  # P(A=1|Z=0)

cat("Marginal outcome rates:\n")
cat(sprintf("E[Y|Z=1] = p_10×θ_10 + p_11×θ_11 = %.2f×%.2f + %.2f×%.2f = %.3f\n", 
            p_10, theta_10, p_11, theta_11, ey_z1))
cat(sprintf("E[Y|Z=0] = p_00×θ_00 + p_01×θ_01 = %.2f×%.2f + %.2f×%.2f = %.3f\n", 
            p_00, theta_00, p_01, theta_01, ey_z0))

cat("\nMarginal treatment rates:\n")
cat(sprintf("E[A|Z=1] = %.2f\n", ea_z1))
cat(sprintf("E[A|Z=0] = %.2f\n\n", ea_z0))

# Computing CACE using IV
cace_iv <- (ey_z1 - ey_z0) / (ea_z1 - ea_z0)

cat("Instrumental Variables Results:\n")
cat(sprintf("CACE = (%.3f - %.3f) / (%.2f - %.2f) = %.3f / %.2f = %.3f\n\n", 
            ey_z1, ey_z0, ea_z1, ea_z0, ey_z1 - ey_z0, ea_z1 - ea_z0, cace_iv))

cat("VERIFICATION:\n")
cat(sprintf("Both methods give identical CACE = %.3f\n", cace_iv))
cat(sprintf("This represents a %.1f percentage point increase in hospitalization\n", cace_iv * 100))
cat("for compliers who are induced by the letter to take the flu shot.\n")
```

Using both principal stratification and instrumental variables methods, I found that the Complier Average Causal Effect (CACE) is `r sprintf("%.3f", cace_iv)`. This means that for individuals who are induced by the physician's letter to take the flu shot (compliers), taking the flu shot **increases** their probability of hospitalization by `r sprintf("%.1f", cace_iv*100)` percentage points. 

This counterintuitive result suggests that for the 20% of the population who are compliers, the combination of receiving the encouragement letter and subsequently getting the flu shot is associated with a higher risk of hospitalization. This could be due to various factors such as: 
1) compliers may be individuals with underlying health conditions who are more responsive to medical advice but also at higher baseline risk
2) the timing of vaccination relative to flu season
3) potential violations of the exclusion restriction if the letter has direct effects on healthcare-seeking behavior.

Ok so both methods yield identical results (CACE = `r sprintf("%.3f", cace_iv)`), which provides confidence in the mathematical consistency of the estimate under the assumed monotonicity and exclusion restriction assumptions. However, the biological plausibility of this positive effect warrants careful interpretation and potential investigation of assumption validity.

